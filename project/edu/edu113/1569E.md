---
title: E. Playoff Restoration
date: 2025-11-12
last_clear: 2025-11-12
tags:
  - edu
  - tag/搜索/折半搜索
  - tag/hash
grasp: 3
value: 5
difficulty: 2600
optional_difficulty:
source: https://codeforces.com/contest/1569/problem/E
article:
---
```cpp showLineNumbers
void solve()
{
    i64 k, a, h;
    cin >> k >> a >> h;
    vector<i64> Ai(40);
    Ai[1] = a;
    for (int i = 2; i < 40; i++) {
        Ai[i] = Ai[i - 1] * a % P;
    }
    auto check = [&](vector<int> vec) -> bool {
        for (int i = 1; i < 1 << (k - 1); i++) {
            for (int p = 0; p + i < 1 << (k - 1); p += i * 2) {
                if (vec[p] == vec[p + i]) {
                    return false;
                } else {
                    if (vec[p] > vec[p + i]) {
                        swap(vec[p], vec[p + i]);
                    }
                }
            }
        }
        return true;
    };
    vector<int> win, lose;
    for (int i = 1; i < k; i++) {
        win.ins(win.end(), (1 << i) / 2, (1 << i) + 1);
        lose.ins(lose.end(), (1 << i) / 2, (1 << i) + 1);
    }
    win.pb(1);
    lose.pb(2);
    sor(win), sor(lose);
    unordered_map<int, int> lftwin, rgtwin;
    int                     id     = 0;
    i64                     lftval = 0, rgtval = 0;
    do {
        if (check(win)) {
            lftval = 0, rgtval = 0;
            for (int i = 0; i < (1 << (k - 1)); i++) {
                lftval    = (lftval + (i + 1) * Ai[win[i]]) % P;
                int rgtid = (i + 1 + (1 << (k - 1)));
                rgtval    = (rgtval + rgtid * Ai[win[i]]) % P;
            }
            lftwin[lftval] = id, rgtwin[rgtval] = id;
        }
        id++;
    } while (next_permutation(all(win)));
    do {
        if (check(lose)) {
            lftval = 0, rgtval = 0;
            for (int i = 0; i < (1 << (k - 1)); i++) {
                lftval    = (lftval + (i + 1) * Ai[lose[i]]) % P;
                int rgtid = (i + 1 + (1 << (k - 1)));
                rgtval    = (rgtval + rgtid * Ai[lose[i]]) % P;
            }
            lftval = (h - lftval + P) % P;
            rgtval = (h - rgtval + P) % P;
            if (lftwin.count(rgtval) || rgtwin.count(lftval)) {
                break;
            }
        }
    } while (next_permutation(all(lose)));
    sor(win);
    int fid = 0;
    if (lftwin.count(rgtval)) {
        fid = lftwin[rgtval];
    } else if (rgtwin.count(lftval)) {
        fid = rgtwin[lftval];
    } else {
        cout << -1 << '\n';
        return;
    }
    for (int i = 0; i < fid; i++) {
        next_permutation(all(win));
    }
    vector<int> ans;
    if (lftwin.count(rgtval)) {
        ans.ins(ans.end(), all(win));
        ans.ins(ans.end(), all(lose));
    } else if (rgtwin.count(lftval)) {
        ans.ins(ans.end(), all(lose));
        ans.ins(ans.end(), all(win));
    }
    for (int i : ans) {
        cout << i << ' ';
    }
    cout << '\n';
}
```
