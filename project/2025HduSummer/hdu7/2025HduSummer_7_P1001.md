---
title: 矩形框选
date: 2025-09-11
last_clear: 2025-09-11
tags:
  - tag/滑动窗口
  - tag/扫描线
grasp: 2
value: 3
difficulty:
optional_difficulty: Bronze
source: https://acm.hdu.edu.cn/contest/problem?cid=1178&pid=1001
article: file:///home/patchouli/Voile/project/2025HduSummer/attachment/2025HduSummer/7/2025HDU第7场题面题解标程/第7场题解.pdf
---
# 题意
在平面上有 $n$ 个点，第 $i$ 个点位于 $(x_i + 0.5,\, y_i + 0.5)$（其中 $x_i, y_i$ 均为整数），其价值为 $v_i$。  
请挑选四个整数 $a,b,c,d$（满足 $a<b,\; c<d$），使得以 $(a,c)、(b,c)、(a,d)、(b,d)$ 为四个顶点的矩形内覆盖的所有点的价值之和最大，且矩形的面积  
$$(b-a) \times (d-c) \leq k$$
## Input
第一行包含一个正整数 $T$（$1 \leq T \leq 100$），表示测试数据的组数。
每组数据的第一行包含两个正整数 $n, k$（$1 \leq n, k \leq 10\,000$），分别表示点数以及矩形的面积上限。
接下来 $n$ 行，每行包含三个正整数 $x_i, y_i, v_i$（$1 \leq x_i, y_i \leq n,\; 1 \leq v_i \leq 10\,000$），分别描述每个点的坐标和价值。请注意，一个位置可能存在多个点。
输入数据保证 $\sum n \leq 100\,000$。
## Output
对于每组数据输出一行一个整数，即矩形内覆盖的所有点的价值之和的最大可能值。
# Solution
## std
假设选出的矩形尺寸是 $w \times h$，固定 $w$ 后 $h$ 越大越好，因此取  
$$h = \left\lfloor \frac{k}{w} \right\rfloor。$$  

随着 $w$ 的增大，$h$ 只有 $2\sqrt{k}$ 种不同的取值，数论分块枚举即可。  

确定矩形的尺寸后，使用扫描线算法找到和最大的 $w \times h$ 子矩阵：按照横坐标从上到下滑动大小为 $w$ 的窗口，令 $f_i$ 表示纵坐标在 $[i,\, i+h-1]$ 的窗口内的点的权值和，那么滑动窗口增删点时，对 $f$ 的影响是一段区间加或区间减，答案为 $f$ 的全局最大值。  

不妨设 $w \geq h$，那么 $h \leq \sqrt{k}$，此时时间复杂度为 $O(nk)$，常数很小已经可以通过，但可以做得更好。  

将 $f$ 数组分成 $\frac{n}{\sqrt{h}}$ 块，每块大小为 $\sqrt{h}$，对于每一块记录块内 $f$ 的最大值 $v$，以及整体需要增加的标记值 $\mathrm{tag}$。在这里不维护全局最大值，而是维护历史全局最大值。  

遇到区间加 $p$（$p > 0$）的操作时：  
- 对于中间完整的块，块内最大值 $v$ 需要加上 $p$，并更新历史全局最大值，块标记值 $\mathrm{tag}$ 也需要加上 $p$。  
- 对于两边零碎的最多两块，暴力修改块内每个元素，并将其值加上块标记值 $\mathrm{tag}$ 来更新历史全局最大值。  

遇到区间减 $p$（$p > 0$）的操作时：  
- 对于中间完整的块，块内最大值 $v$ 需要减去 $p$，块标记值 $\mathrm{tag}$ 也需要减去 $p$。不需要更新历史全局最大值，因为一定不优。  
- 对于两边零碎的最多两块，暴力修改块内每个元素并重算块内最大值 $v$。同理也不需要更新历史全局最大值。  

总时间复杂度为  
$$O\!\left(nk^{\tfrac{3}{4}}\right)。$$
