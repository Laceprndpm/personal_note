---
title: 斐波
date: 2025-08-25
last_clear: 2025-08-25
tags:
  - tag/dp/快速幂
grasp:
difficulty:
source: https://ac.nowcoder.com/study/live/731/6/1
article: https://ac.nowcoder.com/study/live/731/6/1
---
# 题意
假设 $\mathrm{fib}(n)$ 为斐波那契数列第 $n$ 项，其中 $\mathrm{fib}(0) = 0, \mathrm{fib}(1) = 1$ ，且 $\mathrm{fib}(n) = \mathrm{fib}(n - 1) + \mathrm{fib}(n - 2), \ (n > 1)$ 。
假设 $S$ 是一个可重集合 $\{s_1 \dots s_{|S|} \}$ ，$f(S)$ 定义为
$$
f(S) = \sum_{T\subseteq S} \left[\mathrm{fib}(\sum_{t \in T}t)\right]^ 2
$$
数组 $a_1 \dots a_n$ ，$q$ 次操作，两种：
1. 把 $a_p$ 变成 $v$;
2. 计算 $\sum_{i = l}^r \sum_{j = i}^rf(\{a_i \dots a_j\})$。
MOD = 998244353
$(1 \le n, q, a_i, v \le 10^5)$ 时限3s。
# Solution
如果 $f(x)$ 和 $g(x)$ 可以递推
则 $f(x) \cdot g(x)$ 也可以线性递推。
$$
f(S) = \sum_{T\subseteq S} (\text{fib}(\sum_{t \in T}t)) ^ 2
$$
 $g(x) = \text{fib}(x)^2$ 则 
 $$
g(x) = 2g(x-1) + 2g(x-2) - g(x-3)
$$
证明过程就是凑式子，省略

$$
f(S) = \sum_{T \subseteq S} g(\sum_{t \in T} t)
$$
$$
\vec{G}(n)  =
\begin{bmatrix}
g(n) \\
g(n-1) \\
g(n-2)
\end{bmatrix}
=
\begin{bmatrix}
2 & 2 & -1\\
1 & 0 & 0\\
0 & 1 & 0\\
\end{bmatrix}
\begin{bmatrix}
g(n-1) \\
g(n-2) \\
g(n-3)
\end{bmatrix}
=
A^{n-2}
\begin{bmatrix}
g(2) \\
g(1) \\
g(0)
\end{bmatrix}
=
A^{n}
\underbrace{
\begin{bmatrix}
g(0) \\
g(-1) \\
g(-2)
\end{bmatrix}
}_{\vec{G}(0)}
$$

$$
\vec{F}(S) = \sum_{T \subseteq S} \vec{G}(\sum_{t\in T}t)
$$
$$
\vec{F}(S\cup a) = \vec{F}(S) + \underbrace{\overrightarrow{F}(\sum_{t\in T}t + a)}_{A^a\vec{F}(S)} = (I + A^a)\vec{F}(S)
$$
$$
\vec{F}(S) = \prod_{sub \in S}(I + A^{sub})\vec{G}(0)
$$
那么求
$$
\sum_{i = l}^{r}\sum_{j = i}^{r} f({a_i\dots a_j}) = \sum_{i = l}^{r}\sum_{j = i}^{r} \vec{F}({a_i\dots a_j}) = \sum_{i = l}^{r}\sum_{j = i}^{r} \prod_{k = i}^j(I + A^{a_k})\vec{G}(0)
$$
即求区间内所有子区间乘积的和，可以用分治解决。
